var storage={},me={};preinit();
function preinit(){function d(){var b=storage.options.userTagLinks,a=$(".new_comment #comment_content");if(a.length){var c=$(".main div.comments").find(".comment .content > h4").map(function(){return b?$(this).html():$(this).text()}).get().unique(),e=[];$.each(c,function(b,a){e.push({val:a})});a.sew({values:e,elementFactory:function(a,c){a.html(b?$(c.val).text():c.val)}})}}function n(){var b=$(".write-comment");if(b.length){var a=b.prevAll("h3").first(),c=b.siblings("div.comments");b.addClass("mod-write-comment");
c.addClass("mod-comments");a.after(b)}}function p(){var b=$(".main .group-list"),a=_factory(".modation-factory",".modation-group-filter"),c=a.find(".filter");b.addClass("mod-group-list");b.before(a);b.isotope({itemSelector:".group",layoutMode:"vertical",transitionDuration:".3s"});b.imagesLoaded().progress(function(){b.isotope("layout")});handle(c,"input.initGroups",function(){var a=$(this).val().toLowerCase();b.isotope({filter:function(){return-1!=$(this).find(".name").text().toLowerCase().indexOf(a)}})})}
function q(){var b=$(".main .group-list"),a=$(".main .invitations"),c=a.prev("h3");a.addClass("mod-group-invites");b.before(a);a.before(c)}function r(){var b=global.path.home+location.pathname;chrome.runtime.sendMessage({action:"watchlistItemType",link:b},function(a){if(a){var c={watchlist:storage.watchlist},e=c.watchlist.findIndex(function(a){return a.link==b}),d=$("aside > section").first(),f=_factory(".modation-factory",".modation-watchlist-actions"),g=f.children(".add"),h=f.children(".remove"),
k,l;d.before(f);(function m(){if(~e){k=h;l=g;var d=h.find(".unwatch");handle(d,"click.initWatchlist",function(a){a.preventDefault();var b=c.watchlist.splice(e,1);crapi.updateAll(c,function(a){a?(global.debug&&console.log("item unwatched! %o",b),e=-1,m()):console.error("Item not unwatched due to storage lock! Please try again in a few seconds.")})})}else k=g,l=h,d=g.find(".watch"),handle(d,"click.initWatchlist",function(d){d.preventDefault();chrome.runtime.sendMessage({action:"parseWatchlistItem",
link:b,html:document.documentElement.innerHTML,type:a},function(a){var b=c.watchlist.push(a.updates)-1;crapi.updateAll(c,function(a){a?(global.debug&&console.log("item watched! %o",c),e=b,m()):console.error("Item not watched due to storage lock! Please try again in a few seconds.")})})});showView(l,k,0)})()}})}$.get(chrome.extension.getURL("content.html"),function(b){$("body").append(b);crapi.clone(function(a){storage=a;storage.options.userTags&&d();storage.options.moveCommentBox&&n();storage.options.groupFilters&&
p();storage.options.moveGroupInvites&&q();storage.options.showAlertsOnTop&&$(".alert").addClass("mod-alert");storage.options.watchlist&&r();modapi.login(function(a){me=a})})})};
