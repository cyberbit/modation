$(document).ready(function(){parseNotifs();initTabs()});function _factory(a){return $(".factory ."+a).clone()}function initTabs(){$("nav a").click(function(){$(this).parents("nav").find("a").removeClass("active");$(this).addClass("active");$(".main-wrapper .content").hide();var a=$(this).data("tab");$("#"+$(this).data("tab")+"-container").show();"modation-watchlist"==a&&parseWatchlist()});$("nav a:first").click()}
function parseNotifs(){crapi.clone(function(a){modapi.login(function(d){var c=$("<strong>Unknown error</string>");d.success?$.get(global.path.feed,function(b){b=b.replace(/(<iframe\b.*?<\/iframe>)|(<img\b[^>]*>)/ig,"");b=$(b);var f=b.find("aside");f.attr("id","modation-notifications");b=b.find("a[href='/feed']")[0].innerText;var e=parseInt(b.match(/(\d+)/))||0;f&&(c=f);(function(a){a="";if(e){var b=[];f.find("a.author").each(function(){author=$(this).text();-1==b.indexOf(author)&&b.push(author)});
var d=b.length,c=d-3;a=e+" new from ";for(var g=0;2>g&&g<d-1;++g)a+=b[g]+", ";a+=b[g];0<c&&(a+=", plus "+c+" other"+(1<c?"s":""))}e?crapi.badge({title:a,color:"red",text:String(e)}):crapi.badge({title:"No new notifications :(",text:""})})(a[d.email]);$("#modation-notifications").replaceWith(c);$("#modation-notifications a").each(function(){var a=$(this).attr("href");$(this).attr("href",global.path.home+a);$(this).attr("target","_blank")});var h=0;$("#modation-notifications form[action*=clear_notification]").each(function(){var a=
$(this).attr("action");$(this).attr("action",global.path.home+a);$(this).attr("target","clearcatcher"+h);$("#content").after('<iframe width="0" height="0" name="clearcatcher'+h+'" style="display: none"></iframe>');++h});1<h&&($("#modation-notifications div.notifications h3").append('<span class="super clear-notification" id="superclear">Clear All</span>'),$("#superclear").click(function(){$("#modation-notifications form[action*=clear_notification]").submit().parents("div.notifications div").slideUp();
$("#modation-notifications div.notifications h3 img").length||($("#modation-notifications div.notifications h3").append('<img src="img/loading.gif" style="float: right">'),$(this).fadeOut(),parseNotifs())}));$("#modation-notifications input.clear-notification").each(function(){$(this).click(function(){$(this).parents("div.notifications div").slideUp();$("#modation-notifications div.notifications h3 img").length||($("#modation-notifications div.notifications h3").append('<img src="img/loading.gif" style="float: right">'),
parseNotifs())})})}):(crapi.badge({title:"Please login to view notifications",color:"gray",text:"?"}),c=$(_factory("modation-notifications-login")),$("#modation-notifications").replaceWith(c))})})}
function parseWatchlist(){$("#modation-watchlist .loader").show();crapi.clone(function(a){modapi.login(function(d){var c=[];d.success?c=a[d.email]["watchlist-queue"]:console.warn("Could not login to Soundation, bypassing watchlist check");$("#modation-watchlist").find(".clear-notification, .modation-watchlist-item, .empty").remove();c.length?($.each(c,function(a,c){$("#modation-watchlist .wrapper").append(_factory("modation-watchlist-item").addClass("modation-watchlist-item-"+a));var e=$("#modation-watchlist .modation-watchlist-item-"+
a);e.find(".item-title").html('<a href="http://soundation.com/'+c.link+'" target="_blank">'+c.title);e.find(".item-body").html(c.changes.join(", "));e.find(".clear-notification").click(function(){clear_queue(d.email,a);$(this).parents(".notifications .modation-watchlist-item").slideUp(400,function(){$(this).remove();parseWatchlist()})})}),1<$("#modation-watchlist .modation-watchlist-item").length&&$("#modation-watchlist .modation-watchlist-header").append(_factory("modation-watchlist-clear-all").click(function(){purge_queue(d.email);
$("#modation-watchlist .modation-watchlist-item").slideUp(400,function(){$(this).remove();parseWatchlist()})}))):$("#modation-watchlist .wrapper").append(_factory("modation-watchlist-empty"));$("#modation-watchlist .loader").hide()})})}function clear_queue(a,d){crapi.clone(function(c){var b=c[a]["watchlist-queue"][d],f=c[a].watchlist[b.index],e;for(e in b.state)f[e]=b.state[e];c[a].watchlist[b.index]=f;c[a]["watchlist-queue"].splice(d,1);crapi.update(a,c[a])})}
function purge_queue(a){crapi.clone(function(d){$.each(d[a]["watchlist-queue"],function(c,b){var f=d[a].watchlist[b.index],e;for(e in b.state)f[e]=b.state[e];d[a].watchlist[b.index]=f});d[a]["watchlist-queue"]=[];crapi.update(a,d[a])})}
crapi.debug&&(_wItem=function(){$("#modation-watchlist").find(".empty").remove();$("#modation-watchlist .wrapper").append(_factory("modation-watchlist-item").addClass("modation-watchlist-item-debug"));var a=$("#modation-watchlist .modation-watchlist-item-debug").last();a.find(".item-title").html('<a href="#">Debug Item</a>');a.find(".item-body").html("Body, Mind, Soul")});
