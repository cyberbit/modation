var lastPage,save=!0,tracks=[],pages=[],trackInfo=[],optionDefaults={desktop_notifs:!0,sticky_sidebars:!0,group_mods:!0,recent_tracks:!0,profile_tips:!0,group_tips:!0,smart_player:!0,player_actions:!0,comment_tags:!0,dynamic_feed:!1,small_feed:!1};$(function(){initOptions();initStorage();initTracks();initWatchlist();initPages();$(window).on("hashchange",function(){parseHash()});selectMenu("tab-community","menu-sticky-sidebars");login()});
function initOptions(){$("#check-login").click(login);$(".option").change(save_options)}
function initStorage(){var a=$("#tab-storage"),b=$(".storage-copy"),c=$(".storage-confirm");a.find("#progressContainer").html('<div><div class="progressStatus">&nbsp;</div><div id="progress"></div><div>');var e=a.find("#progress"),d=a.find(".progressStatus");d.text("Loading...");e.progressbar({value:!1});e.height(20);var l=crapi.storage().QUOTA_BYTES,f=(l/1024).toFixed(2);crapi.storage().getBytesInUse(function(a){var c=(a/1024).toFixed(2);a=(100*a/l).toFixed(2);d.text(c+" of "+f+" KiB ("+a+"%)");
progress("tab-storage",parseFloat(a))});crapi.clone(function(a){b.text(btoa(JSON.stringify(a)))});b.click(function(){this.select()});$(".storage-paste").on("input change",function(){var a=$(this),b="No data",e="",d="empty";if(a.val()){e="text-";try{$.parseJSON(atob(a.val())),b="Looks good!",d="success",c.removeClass("disabled")}catch(u){b="Invalid storage, try again!",d="danger",c.addClass("disabled")}}else c.addClass("disabled");$(".storage-status").removeClass("empty text-danger text-success").addClass(e+
d).text(b)});c.click(function(){if(confirm("Are you sure you wish to overwrite your saved storage? This action is not reversible!\n\nPress OK to confirm.")){var a=$.parseJSON(atob($(".storage-paste").val()));crapi.updateAll(a,function(){error('<strong>Storage pasted! Please reload Modation to load these changes.</strong><br><input class="nice-button orange noshadow" id="reload-browser" type="button" style="padding: 5px 8px;" value="Reload now">');$("#reload-browser").click(function(){chrome.runtime.reload()});
$(".cover").fadeIn(150)})}})}function initTracks(){$("#track-filter").hide();$("#download-tracks").click(getTracks)}function initWatchlist(){$("#check-watchlist").click(function(){$("#watchlist-container .wItem").addClass("load");check_watchlist(!0,refresh_watchlist)})}
function initPages(){$("header .sub a").click(function(){$(this).attr("data-tab");location.hash="#"+$(this).attr("data-hash")});$(".menu a").click(function(){var a=$(this).parents(".main-wrapper").attr("id"),b=$(this).attr("data-menu");selectMenu(a,b,function(a){"menu-watchlist"==a&&refresh_watchlist()})})}function _factory(a){return $(".factory ."+a).clone()}
function parseHash(){""===location.hash&&(location.hash="#general");"#general"===location.hash&&selectTab("tab-general");"#storage"===location.hash&&selectTab("tab-storage");"#notifs"===location.hash&&selectTab("tab-notifs");"#community"===location.hash&&selectTab("tab-community");"#tracks"===location.hash&&selectTab("tab-tracks");"#about"===location.hash&&selectTab("tab-about")}
function selectTab(a){$('[data-tab="'+a+'"]').is(".current")||($("header .sub a").removeClass("current"),$('[data-tab="'+a+'"]').addClass("current"),$(".main-wrapper").hide(),$("#"+a).show(),"tab-about"==a&&(a=crapi.manifest(),$("#modation_version").html("Version: <strong>"+a.version+(a.version_suffix?"-"+a.version_suffix:"")+"</strong>"),$("#modation_author").html("Author: <strong>"+a.author+"</strong>"),getChangelog()))}
function selectMenu(a,b,c){"undefined"==typeof c&&(c=function(){});$("#"+a+' [data-menu="'+b+'"]').is(".current")||($("#"+a+" .menu.column a").removeClass("current"),$("#"+a+' [data-menu="'+b+'"]').addClass("current"),$("#"+a+' [id^="menu-"]').hide(),$("#"+a+" #"+b).show());c(b)}
function login(){$loader=$("#logincheck .loader");$loader.fadeIn(150);$("header .sub a:not(.current)").addClass("disabled");modapi.login(function(a){a.success?(save||$("#notification-bar").animate({top:"-59px"},"fast","easeOutQuart",function(){$(this).remove()}),save=!0,$(".cover").fadeOut(150),$("#email").val(a.email),restore_options(),$("header .sub a").removeClass("disabled"),$(window).trigger("hashchange")):(save=!1,$(".cover").fadeIn(150),error('<strong>Uh oh, looks like you are not logged in! <a href="http://soundation.com/feed" target="_blank" style="color: #de5931">Login</a></strong><br><input class="nice-button orange noshadow" id="check-login-again" type="button" style="padding: 5px 8px;" value="Double-check">'),
$("#check-login-again").click(login));$loader.fadeOut(150)})}
function getTracks(){$(".track").fadeOut(400,function(){$(this).remove()});$("#track-filter, #filter-result").fadeOut();$("#tab-tracks aside").fadeOut(400,function(){$("#tab-tracks .aside-cover").fadeOut(200);$("#tab-tracks aside").trigger("sticky_kit:detach");$(this).remove()});$("#tab-tracks #progress").length||($("#tab-tracks #progressContainer").html('<div><div class="progressStatus">&nbsp;</div><div id="progress"></div><div>'),$("#tab-tracks #progress").parent().hide(),$("#tab-tracks #progress").progressbar({value:!1}),
$("#tab-tracks #progress").height(10),$("#tab-tracks #progress").parent().fadeIn(150));progressStatus("tab-tracks","Paginating...");$.get("http://soundation.com/account/tracks",function(a){a=a.replace(/<img\b[^>]*>/ig,"");lastPage=$(a).find(".pagination .last a").prop("href");lastPage="undefined"==typeof lastPage?1:lastPage.match(/(?:page=)(\d*)/i)[1];for(a=1;a<=lastPage;a++)getTrackPage(a)})}
function getTrackPage(a){var b=[];pages.push(a);$.get("http://soundation.com/account/tracks?page="+a,function(c){$(c).find(".track").each(function(){b.push($($(this)[0].outerHTML).append('<input type="hidden" value="'+a+'">')[0].outerHTML)});tracks[a]=b;c=pages.indexOf(a);pages.splice(c,1);c=(lastPage-pages.length)/lastPage*100;progressStatus("tab-tracks","Working page "+a+"...");progress("tab-tracks",c);pages.length||($("#tab-tracks #progress").parent().fadeOut(150,function(){$(this).remove()}),
enumerateTrackList())})}function getChangelog(){$("#modation_changelog").before('<span class="loader">Grabbing current information... <img src="img/loadingf5t.gif"></span>');$.get("http://soundation.com/group/modation",function(a){a=$(a).find('h3:contains("Changelog") + div').html();$("#modation_changelog").html(a);$("#tab-about .loader").remove()})}
function editTrack(a,b){$("#tab-tracks aside").length||($("#tab-tracks").prepend('<aside style="display: none"><div class="container"><div class="aside-cover"><img src="img/loadingealarget.gif"></div><div class="wrapper"><h3>Modation Track Editor</h3></div><form accept-charset="UTF-8" enctype="multipart/form-data" id="edit_mixdown"><div class="wrapper"><input name="_method" type="hidden" value="put"><input id="token" name="authenticity_token" type="hidden" value=""><label for="mixdown_title">Title</label><input id="mixdown_title" maxlength="100" name="mixdown[title]" size="100" type="text" style="width: 93%"><label for="mixdown_description">Description</label><textarea id="mixdown_description" maxlength="255" name="mixdown[description]" style="width: 93%; height: 75px; resize: vertical"></textarea><label for="mixdown_genre_id" style="padding-right: 3px">Genre:</label><select id="mixdown_genre_id" name="mixdown[genre_id]" style="margin: 0"><option value="">None</option><option value="1">Blues</option><option value="2">Classical</option><option value="3">Country</option><option value="4">DJ Effects</option><option value="5">Electronica</option><option value="6">Funk</option><option value="7">Hip Hop/Urban</option><option value="8">Jazz</option><option value="9">Latin</option><option value="10">Reggae</option><option value="11">Rock</option><option value="12">World</option></select></div><div class="wrapper" style="text-align: center"><input name="mixdown[published]" type="hidden" value="0"><input id="mixdown_published" class="toggle visible nice-button green" name="mixdown[published]" type="checkbox" value="1"><input name="mixdown[allow_comments]" type="hidden" value="0"><input id="mixdown_allow_comments" class="toggle comments nice-button orange" name="mixdown[allow_comments]" type="checkbox" value="1"><input name="mixdown[allow_download]" type="hidden" value="0"><input id="mixdown_allow_download" class="toggle download nice-button blue" name="mixdown[allow_download]" type="checkbox" value="1"></div></form><div class="wrapper last" style="text-align: center"><a id="save" class="nice-button orange large">Save</a></div></div></aside>'),$("#tab-tracks aside").fadeIn());
$("#edit_mixdown").off("submit");$("#edit_mixdown").submit(function(c){saveTrack(a,b);c.preventDefault()});$("#tab-tracks aside").stick_in_parent();$("#tab-tracks aside").addClass("disabled");$("#tab-tracks .aside-cover").fadeIn(200);$.get("http://soundation.com/account/tracks/"+a+"/edit",function(a){trackInfo=[];a=$(a);trackInfo.token=a.find('[name="authenticity_token"]').val();trackInfo.title=a.find("#mixdown_title").val();trackInfo.desc=a.find("#mixdown_description").text();trackInfo.genre=a.find("#mixdown_genre_id").val();
trackInfo.visible=a.find("#mixdown_published").is(":checked");trackInfo.comments=a.find("#mixdown_allow_comments").is(":checked");trackInfo.download=a.find("#mixdown_allow_download").is(":checked");$("#token").val(trackInfo.token);$("#mixdown_title").val(trackInfo.title);$("#mixdown_description").text(trackInfo.desc);$("#mixdown_genre_id").prop("selectedIndex",trackInfo.genre);$("#mixdown_published").prop("checked",trackInfo.visible);$("#mixdown_allow_comments").prop("checked",trackInfo.comments);
$("#mixdown_allow_download").prop("checked",trackInfo.download);$("#tab-tracks aside").removeClass("disabled");$("#tab-tracks .aside-cover").fadeOut(200)});$("#save").off("click.save");$("#save").on("click.save",function(){saveTrack(a,b)})}
function saveTrack(a,b){$("#tab-tracks aside").addClass("disabled");$("#tab-tracks .aside-cover").fadeIn(200);$.post("http://soundation.com/account/tracks/"+a,$("#edit_mixdown").serialize(),function(){$("#tab-tracks aside").fadeOut(400,function(){$("#tab-tracks .aside-cover").fadeOut(200);$("#tab-tracks aside").trigger("sticky_kit:detach");$(this).remove()});updateTrack(a);status("Track saved.")})}
function enumerateTrackList(){for(var a=[],b=1;b<tracks.length;b++)a=a.concat(tracks[b]);$.each(a,function(a,b){$(".tracks-container").append(b)});$(".track").hide();$('a[href*="edit"]').each(function(){var a=$(this).prop("href").match(/tracks\/(\d*)/)[1];$(this).on("click",function(b){editTrack(a,$(this).parents("div.track").find('input[type="hidden"]').val());b.preventDefault()})});$(".actions a").each(function(){var a=$(this).attr("href");a.match(/powerfx\.soundation-mixdowns/)?$(this).prop("target",
"dummy"):($(this).attr("href","http://soundation.com"+a),$(this).prop("target","_blank"))});$("#track-filter").val("");$(".track, #track-filter, #filter-result").fadeIn();$("#track-filter").fastLiveFilter(".tracks-container",{selector:"h3",callback:function(a){$("#filter-result").html("Showing "+a+" track"+(1!=a?"s":""));$("#tab-tracks aside").trigger("sticky_kit:detach");$("#tab-tracks aside").stick_in_parent()}})}
function updateTrack(a){var b=getTrack(a).wrapInner('<div class="inner-wrap"></div>').prepend('<div class="track-cover"><img src="img/loadingealarget.gif" style="border-bottom: none"></div>').find('input[type="hidden"]').val(),c=getTrack(a);c.addClass("disabled");c.find(".track-cover").fadeIn(200);$.get("http://soundation.com/account/tracks?page="+b,function(c){c=$(c);c=$(getTrack(a,c)[0].outerHTML).append('<input type="hidden" value="'+b+'">')[0].innerHTML;getTrack(a).find(".inner-wrap").replaceWith(c);
c=getTrack(a);c.prepend('<div class="track-cover" style="display: block"><img src="img/loadingealarget.gif" style="border-bottom: none"></div>');c.find('a[href*="edit"]').each(function(){$(this).on("click",function(c){editTrack(a,b);c.preventDefault()})});c.removeClass("disabled");c.find(".track-cover").fadeOut(200)})}function getTrack(a,b){return"undefined"!=typeof b?b.find('a[href*="/tracks/'+a+'/edit"]').parents("div.track"):$('a[href*="/tracks/'+a+'/edit"]').parents("div.track")}
function save_options(){crapi.clone(function(a){var b=$("#email").val(),c=a[b];save&&$(".option").each(function(){var a=$(this).attr("id");c[a]=$(this).is(":checked")});crapi.update(b,c,function(){status("Settings saved.")})})}function progressStatus(a,b){$("#"+a+" .progressStatus").text(b)}function progress(a,b){$("#"+a+" #progress").progressbar("value",b)}function status(a){showNotificationBar("undefined"==typeof a?"Something happened.":a,1300,"#15842f","white")}
function error(a){showNotificationBar("undefined"==typeof a?"Something <strong>bad</strong> happened.":a,0,"#842f15","white",58)}
function restore_options(){var a=$("#email").val();crapi.clone(function(b){"undefined"==typeof b[a]&&(b[a]={});var c=0,e=function(){status("Settings restored.")};$(".option").each(function(){var d=$(this).attr("id");d in b[a]||(b[a][d]=d in optionDefaults?optionDefaults[d]:!0,c++);$("#"+d).attr("checked",b[a][d])});"undefined"==typeof b[a].watchlist&&(b[a].watchlist=[]);"undefined"==typeof b[a]["watchlist-queue"]&&(b[a]["watchlist-queue"]=[]);c?(console.info("Some settings missing, setting defaults..."),
save_options(),crapi.update(a,b[a],e)):e()})}
function check_watchlist(a,b){"undefined"==typeof a&&(a=!0);"undefined"==typeof b&&(b=function(){});var c=$("#email").val(),e=[];crapi.clone(function(d){function l(){var l=[];$.each(e,function(a,b){var e=b.link,n=$(b.html),g={},f={};delete b.html;var p=e.match(/user\/.*\/track\//)?!0:!1,m=e.match(/group\/.*/)?!0:!1,h=n.find(".comment .actions").children(".flag, .delete").first();if(h.length){var k;switch(h.attr("class")){case "flag":k=h.attr("onclick");break;case "delete":k=h.attr("href")}"undefined"!=
typeof k&&(g.comment=k.match(/(\d+)/g)[0])}p?(g.title=n.find("#main .title").text(),g.likes=n.find(".stats .likes").text(),g.downloads=n.find(".stats .downloads").text()):m&&(g.title=n.find("#group-info h2").html(),n=n.find("#group-info .info").text(),g.members=n.match(/(\d*) member/)[1],g.following=n.match(/(\d*) follower/)[1]);k=g.title;h=g.likes;m=g.downloads;p=g.members;n=g.following;g=g.comment;k&&(f.title=k,d[c].watchlist[a].title=k);if(h&&b.likes!=h){var q=k=h-b.likes;0<k&&(q="+"+k);d[c].watchlist[a].likes=
h;isNaN(k)||(f.likes=q+" like"+(1<k||-1>k?"s":""))}m&&b.downloads!=m&&(h=m-b.downloads,k="+"+h,d[c].watchlist[a].downloads=m,isNaN(h)||(f.downloads=k+" download"+(1<h?"s":"")));p&&b.members!=p&&(h=m=p-b.members,0<m&&(h="+"+m),d[c].watchlist[a].members=p,isNaN(m)||(f.members=h+" members"+(1<m||-1>m?"s":"")));n&&b.following!=n&&(m=p=n-b.following,0<p&&(m="+"+p),d[c].watchlist[a].following=n,isNaN(p)||(f.following=m+" follower"+(1<p||-1>p?"s":"")));g&&b.comment!=g&&("undefined"!=typeof b.comment&&(f.comment=
"New comment"),d[c].watchlist[a].comment=g);1<Object.keys(f).length&&(f.link=e,l.push(f))});console.debug("final iteration complete!");a?crapi.update(c,d[c],b):b()}var f=d[c].watchlist||{},q=f.length,r=0;$.each(f,function(a,b){var c=b.link;$.get("http://soundation.com/"+c,function(c){b.html=c;e[a]=b}).fail(function(){b.fail=!0;e[a]=b}).done(function(){delete b.fail}).always(function(){r++;$("[value='"+c+"']").closest(".wItem").removeClass("load");r==q&&(status("Watchlist updated successfully."),console.debug("final check complete!"),
l())})})})}function delete_watchlist(a,b){"undefined"==typeof b&&(b=function(){});var c=$("#email").val();crapi.clone(function(e){var d=!1;$.each(e[c].watchlist,function(b,f){return f.link==a?(e[c].watchlist.splice(b,1),d=!0,!1):!0});d&&crapi.update(c,e[c],b)})}
function refresh_watchlist(){var a=$("#email").val();crapi.clone(function(b){b=b[a].watchlist||{};var c=$("#watchlist-container");c.html("");$.each(b,function(a,b){var l=_factory("wItem");try{var f=b.link,q=b.title,r=f.match(/user\/.*\/track\//)?!0:!1,s=f.match(/group\/.*/)?!0:!1;r&&l.addClass("track");s&&l.addClass("group");b.fail&&l.addClass("fail");l.find(".label").html(q);l.find(".link").val(f);l.find("button.view").click(function(){window.open("http://soundation.com/"+f,"_blank")});l.find("button.remove").click(function(){confirm("Click OK to remove '"+
q+"' from your watchlist.\n\nYou can always add it again later by using the 'Watch' button on the page.")&&delete_watchlist(f,refresh_watchlist)})}catch(t){console.err(t)}l.appendTo(c)})})}
function showNotificationBar(a,b,c,e,d){fallbackHeight=25;b="undefined"!==typeof b?b:1500;c="undefined"!==typeof c?c:"#F4E0E1";e="undefined"!==typeof e?e:"#A42732";d="undefined"!==typeof d?d:25;a="<div class='notification-message' style='text-align:center; line-height: "+(58==d?fallbackHeight:d)+"px;'> "+a+" </div>";0<$("#notification-bar").length?($("#notification-bar").html(a),$("#notification-bar").effect("highlight",{color:"#0b4218"},"fast")):$("body").prepend("<div id='notification-bar' style='width:100%; height:0px; background-color: "+
c+"; position: fixed; z-index: 100; color: "+e+";border-bottom: 1px solid "+e+";left: 0px;top: 0px;'>"+a+"</div>");$("#notification-bar").animate({height:d+"px"},"fast","easeOutBack");window.clearTimeout($("#notification-bar").data("timeout"));0!=b&&$("#notification-bar").data("timeout",setTimeout(function(){$("#notification-bar").animate({top:"-"+(d+1)+"px"},"fast","easeOutQuart",function(){$(this).remove()})},b))};
