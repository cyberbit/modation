var alarmRunning=!1,msgFunctions={},cacheKeys=["notifData","blobs","options"];
$(function(){function q(a){crapi.clone($.extend(!0,{},global.storageModel,{options:global.optionDefaults}),function(c){function b(){var b=moment().format();localStorage.installed=b;localStorage.version=d;console.log("cache options");localJSON("options",c.options);var g={type:"basic",iconUrl:"img/newiconflat128.png",title:"Modation has updated!",message:"Click here to see what's new.",contextMessage:("update"==a.reason?"v"+a.previousVersion+" => ":"")+"v"+d};chrome.notifications.create("modation_update",
g,function(b){f("modation_update",{notif:g,link:"http://djmarcolesco.me/modation/",actions:[]})})}var d=crapi.manifest().version;c.version||(crapi.storage("local").clear(),crapi.storage("sync").clear(),console.info("No storage version, clearing storage"));c.version!==d||"update"==a.reason?crapi.updateAll($.extend(!0,{},global.storageModel,c,{version:d}),function(){console.info("Updated storage model");b()}):b()})}function r(){(function(a){a.rememberMe&&chrome.cookies.get({url:global.path.cookie,name:global.cookie},
function(a){a=a||{};a.session&&chrome.cookies.set({url:global.path.cookie,name:global.cookie,value:a.value,domain:a.domain,path:a.path,secure:a.secure,httpOnly:a.httpOnly,expirationDate:moment().add(1,"w").unix()},function(a){})})})(localJSON("options"))}function k(a){var c=chrome.extension.getViews({type:"popup"});modapi.login(function(b){if("feed"==a.name)try{if(b.success)alarmRunning?console.info("Alarm running, notification handler cancelled"):c.length?console.info("Popup open, notification handler cancelled"):
(f("modation_login",""),alarmRunning=!0,console.log("Modation :: Check notifications"),$.get(global.path.feed,function(a){a=$(a.deres()).find("aside").find(".notifications .notification");var b=[],c=[];a.find("a").each(function(a,b){var c=$(b),d=c.attr("href");c.attr("href",global.path.home+d)});var d=0;a.each(function(a,e){var g=$(e),v=g.find(".actions").children(),l=g.clone();l.find("time, .clear, .actions").remove();var k=l.find("a");l.find(".author").remove();var m="modation"+g.find(".clear").attr("href").match(/(?:\/)(\d+)/)[1],
p=g.find("time").text(),u=g.find(".author"),q=u.text();u.attr("href");var r=l.text().trim(),n=k.last().attr("href"),t=g.find(".clear").attr("href"),s=[];v.each(function(a,b){s.push({title:$(this).text(),link:$(this).attr("href"),data:$(this).data()})});if(n.match(/\/account\/messages\/\d+$/)){if(-1!=$.inArray(n,b))return;b.push(n)}c.push(m);(function(a){function b(){f(m,{notif:c,link:n,clear:t,actions:s});++d;d==Object.keys(f()).length&&h()}var c={type:"basic",iconUrl:a,title:q,message:r,contextMessage:p,
buttons:s.map(function(a){return{title:a.title}})};f(m)?b():chrome.notifications.create(m,c,function(a){b()})})("img/newiconflat128.png")});a=Object.keys(f());$.each(a.diff(c),function(a,b){chrome.notifications.clear(b);f(b,"")});0===d&&h();alarmRunning=!1}));else{console.warn("Could not login to Soundation");crapi.badge({title:"Please login to view notifications",color:"gray",text:"?"});var d=[{title:"Login with Facebook",link:global.path.home+"/users/auth/facebook",data:{}},{title:"Login with Google",
link:global.path.home+"/users/auth/google_oauth2",data:{}}],e={type:"basic",iconUrl:"img/newiconflat128.png",title:"Login to Soundation",message:"Click here to login, or use one of the buttons below.",buttons:d.map(function(a){return{title:a.title}})};f("modation_login")||chrome.notifications.create("modation_login",e,function(a){f("modation_login",{notif:e,link:global.path.login,actions:d})});alarmRunning=!1}}catch(g){console.error("Unknown error occurred: %o",g),alarmRunning=!1}})}function f(a,
c){var b=localStorage.notifData,b=b?$.parseJSON(b):{};if("undefined"==typeof a)return b;"undefined"==typeof c&&(c=!1);var d=b[a];""===c?delete b[a]:c&&(b[a]=c);localStorage.notifData=JSON.stringify(b);return d}function t(){var a=f();$.each(a,function(a,b){chrome.notifications.create(a,b.notif,function(){})});a.modation_login||h()}function h(){var a=Object.keys(f()).length;crapi.badge({title:0==a?"No new notifications :(":a+" new notification"+(1<a?"s":""),color:"red",text:a?String(a):""})}function p(){$.each(cacheKeys,
function(a,c){delete localStorage[c]});console.info("Cache cleared")}function w(){crapi.clone({options:global.optionDefaults},function(a){console.log("cache options");localJSON("options",a.options)})}(function(){chrome.runtime.onInstalled.addListener(function(a){p();q(a)});chrome.runtime.onStartup.addListener(function(){p();w();h()});chrome.runtime.onMessage.addListener(function(a,c,b){if(msgFunctions[a.action])msgFunctions[a.action](a,c,b)});msgFunctions.confirm=function(a,c,b){b(confirm(a.msg))};
(msgFunctions.rememberMe=function(){chrome.cookies&&chrome.cookies.onChanged.addListener(function(a){"explicit"!=a.cause&&r()})})()})();(function(){chrome.alarms.create("feed",{delayInMinutes:modapi.manifest.debug?0:1,periodInMinutes:1});chrome.alarms.onAlarm.addListener(k);handle($("body"),"alarm.initAlarms",function(){k({name:"feed"})})})();(function(){function a(a,d,e){"undefined"!=typeof e&&(e=f(d).actions[e],e.data.method?$.post(e.link,{_method:e.data.method,authenticity_token:modapi.token()}):
a=e.link);chrome.windows.getCurrent(function(c){chrome.tabs.create({windowId:c.id,url:a});chrome.windows.update(c.id,{focused:!0})});c(d)}function c(a){chrome.notifications.clear(a);f(a).clear&&$.post(f(a).clear,{_method:"delete",authenticity_token:modapi.token()});f(a,"");h()}chrome.notifications.onClicked.addListener(function(b){var c=f(b);c&&a(c.link,b)});chrome.notifications.onButtonClicked.addListener(function(b,c){var e=f(b);if(e){var g=e.actions[c];g.data.confirm?confirm(g.data.confirm)&&a(e.link,
b,c):a(e.link,b,c)}});chrome.notifications.onClosed.addListener(function(a,d){d&&c(a)});msgFunctions.showAllNotifications=function(){t()}})()});
