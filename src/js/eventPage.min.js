var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.findInternal=function(b,g,h){b instanceof String&&(b=String(b));for(var k=b.length,d=0;d<k;d++){var f=b[d];if(g.call(h,f,d,b))return{i:d,v:f}}return{i:-1,v:void 0}};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(b,g,h){b!=Array.prototype&&b!=Object.prototype&&(b[g]=h.value)};
$jscomp.getGlobal=function(b){return"undefined"!=typeof window&&window===b?b:"undefined"!=typeof global&&null!=global?global:b};$jscomp.global=$jscomp.getGlobal(this);$jscomp.polyfill=function(b,g,h,k){if(g){h=$jscomp.global;b=b.split(".");for(k=0;k<b.length-1;k++){var d=b[k];d in h||(h[d]={});h=h[d]}b=b[b.length-1];k=h[b];g=g(k);g!=k&&null!=g&&$jscomp.defineProperty(h,b,{configurable:!0,writable:!0,value:g})}};
$jscomp.polyfill("Array.prototype.find",function(b){return b?b:function(b,h){return $jscomp.findInternal(this,b,h).v}},"es6","es3");$jscomp.SYMBOL_PREFIX="jscomp_symbol_";$jscomp.initSymbol=function(){$jscomp.initSymbol=function(){};$jscomp.global.Symbol||($jscomp.global.Symbol=$jscomp.Symbol)};$jscomp.Symbol=function(){var b=0;return function(g){return $jscomp.SYMBOL_PREFIX+(g||"")+b++}}();
$jscomp.initSymbolIterator=function(){$jscomp.initSymbol();var b=$jscomp.global.Symbol.iterator;b||(b=$jscomp.global.Symbol.iterator=$jscomp.global.Symbol("iterator"));"function"!=typeof Array.prototype[b]&&$jscomp.defineProperty(Array.prototype,b,{configurable:!0,writable:!0,value:function(){return $jscomp.arrayIterator(this)}});$jscomp.initSymbolIterator=function(){}};$jscomp.arrayIterator=function(b){var g=0;return $jscomp.iteratorPrototype(function(){return g<b.length?{done:!1,value:b[g++]}:{done:!0}})};
$jscomp.iteratorPrototype=function(b){$jscomp.initSymbolIterator();b={next:b};b[$jscomp.global.Symbol.iterator]=function(){return this};return b};$jscomp.iteratorFromArray=function(b,g){$jscomp.initSymbolIterator();b instanceof String&&(b+="");var h=0,k={next:function(){if(h<b.length){var d=h++;return{value:g(d,b[d]),done:!1}}k.next=function(){return{done:!0,value:void 0}};return k.next()}};k[Symbol.iterator]=function(){return k};return k};
$jscomp.polyfill("Array.prototype.keys",function(b){return b?b:function(){return $jscomp.iteratorFromArray(this,function(b){return b})}},"es6","es3");var alarmRunning=!1,msgFunctions={},cacheKeys=["notifData","blobs","options"];
$(function(){function b(a){crapi.clone($.extend(!0,{},global.storageModel,{options:global.optionDefaults}),function(b){function c(){var c=moment().format();localStorage.installed=c;localStorage.version=e;localJSON("options",b.options);var m={type:"basic",iconUrl:"img/newiconflat128.png",title:"Modation has updated!",message:"Click here to see what's new.",contextMessage:("update"==a.reason?"v"+a.previousVersion+" => ":"")+"v"+e};chrome.notifications.create("modation_update",m,function(){f("modation_update",
{notif:m,link:"http://djmarcolesco.me/modation/",actions:[]})})}var e=crapi.manifest().version;b.version||(crapi.storage("local").clear(),crapi.storage("sync").clear(),console.info("No storage version, clearing storage"));b.version!==e||"update"==a.reason?crapi.updateAll($.extend(!0,{},global.storageModel,b,{version:e}),function(){console.info("Updated storage model");c()}):c()})}function g(){(function(a){a.rememberMe&&chrome.cookies.get({url:global.path.cookie,name:global.cookie},function(a){a=a||
{};a.session&&chrome.cookies.set({url:global.path.cookie,name:global.cookie,value:a.value,domain:a.domain,path:a.path,secure:a.secure,httpOnly:a.httpOnly,expirationDate:moment().add(1,"w").unix()},function(){})})})(localJSON("options"))}function h(a){return a.matchAny({group:global.regex.groupLink,track:global.regex.trackLink})}function k(a,b,c){c=c||h(a);var e=global.watchlistModel[c];e.link=a;a=$(b);if("track"==c){b=parseInt(a.find(".stats .likes").text());var f=parseInt(a.find(".stats .downloads").text());
a=parseInt(a.find(".stats .comments").text());$.extend(e,{likes:b,downloads:f,comments:a})}else if("group"==c){b=(a.find(".comments .comment:first .content > p").html()||"").hashCode();f=parseInt(a.find(".stats a[href*=members] b").text());var g=parseInt(a.find(".stats a[href*=followers] b").text());a=parseInt(a.find(".stats a[href*=tracks] b").text());$.extend(e,{lastComment:b,members:f,followers:g,tracks:a})}return{updates:e,type:c}}function d(a){var b=chrome.extension.getViews({type:"popup"}),
c=localJSON("options")||{};modapi.login(function(e){if("feed"==a.name)try{if(e.success)alarmRunning?console.info("Alarm running, notification handler cancelled"):b.length?console.info("Popup open, notification handler cancelled"):(f("modation_login",""),alarmRunning=!0,console.log("Modation :: Check notifications"),$.get(global.path.feed,function(a){var b=$(a.deres()).find("aside").find(".notifications .notification"),c=[],e=[];b.find("a").attr("href",function(a,b){return global.path.home+b});var g=
0;b.each(function(a,h){function d(a){function c(){f(r,{notif:e,link:l,clear:x,actions:u});++g;g==b.length&&p()}var e={type:"basic",iconUrl:a,title:m,message:y,contextMessage:z,buttons:u.map(function(a){return{title:a.title}})};f(r)?c():chrome.notifications.create(r,e,function(){c()})}a=$(h);h=a.find(".actions").children();var t=a.clone();t.find("time, .clear, .actions").remove();var A=t.find("a");t.find(".author").remove();var r="modation"+a.find(".clear").attr("href").match(/(?:\/)(\d+)/)[1],z=a.find("time").text(),
k=a.find(".author"),m=k.text(),q=k.attr("href"),y=t.text().trim(),l=A.last().attr("href"),x=a.find(".clear").attr("href"),u=[];h.each(function(){u.push({title:$(this).text(),link:$(this).attr("href"),data:$(this).data()})});if(l.match(global.regex.messageLink)){if(-1!=$.inArray(l,c))return;c.push(l)}e.push(r);var n=l.match(global.regex.groupLink);a=localJSON("blobs")||{};a[n?l:q]?d(a[n?l:q]):$.get(n?l:q,function(a){a=$(a).find((n?".top .inner .container":"aside")+" img").attr("src");getDataUri("img/newiconflat128.png",
a,function(a){var b=localJSON("blobs")||{};b[n?l:q]=a;localJSON("blobs",b);d(a)})})});a=Object.keys(f()).filter(function(a){return a.match(/modation(\d)+/)});$.each(a.diff(e),function(a,b){chrome.notifications.clear(b);f(b,"")});0===g&&p();alarmRunning=!1}));else{console.warn("Could not login to Soundation");crapi.badge({title:"Please login to view notifications",color:"gray",text:"?"});var g=[{title:"Login with Facebook",link:global.path.home+"/users/auth/facebook",data:{}},{title:"Login with Google",
link:global.path.home+"/users/auth/google_oauth2",data:{}}],d={type:"basic",iconUrl:"img/newiconflat128.png",title:"Login to Soundation",message:"Click here to login, or use one of the buttons below.",buttons:g.map(function(a){return{title:a.title}})};f("modation_login")||chrome.notifications.create("modation_login",d,function(){f("modation_login",{notif:d,link:global.path.login,actions:g})});alarmRunning=!1}}catch(w){console.error("Unknown error occurred: %o",w),alarmRunning=!1}else"watchlist"==
a.name&&c.watchlist&&crapi.clone(["watchlist"],function(a){if(e.success){var b="undefined"==typeof testWatchlist?a.watchlist:testWatchlist,c=[],g=[],d=0;$.each(b,function(a,e){c[a]=e;g[a]={};var l=h(e.link);g[a].type=l;$.get(e.link,function(b){b=$(b);var d=k(e.link,b,l).updates;if("track"==l)g[a].title=b.find(".title").text().trim(),global.debug&&console.log("track %o: current %o, new %o",e.link,{likes:e.likes,downloads:e.downloads,comments:e.comments},d);else if("group"==l){var f=b.find(".comments .comment:first"),
h=f.find(".comment-author");f=f.find(".content > p");g[a].title=b.find(".group-hero-container-info > h2").text();g[a].commentBody=f.text();g[a].commentAuthor=h.text();g[a].commentAuthorLink=h.find("a").attr("href");global.debug&&console.log("group %o: current %o, new %o",e.link,{lastComment:e.lastComment,members:e.members,followers:e.followers,tracks:e.tracks},d)}c[a]=$.extend({},c[a],d)}).always(function(){++d;if(d==b.length){var a=[];$.each(c,function(c,e){var d=b[c],f=g[c];a[c]=[];if("track"==
f.type){f=e.likes-d.likes;var h=e.downloads-d.downloads;d=e.comments-d.comments;f&&a[c].push(f+" like"+(1==Math.abs(f)?"":"s"));h&&a[c].push(h+" download"+(1==Math.abs(h)?"":"s"));d&&a[c].push(d+" comment"+(1==Math.abs(d)?"":"s"));global.debug&&console.log("changes for track %o: %o",e.link,a[c])}else if("group"==f.type){h=e.followers-d.followers;var l=e.members-d.members,k=e.tracks-d.tracks;e.lastComment!==d.lastComment&&f.commentBody&&a[c].push("New comment from @"+f.commentAuthor);h&&a[c].push(h+
" follower"+(1==Math.abs(h)?"":"s"));l&&a[c].push(l+" member"+(1==Math.abs(l)?"":"s"));k&&a[c].push(k+" track"+(1==Math.abs(k)?"":"s"));global.debug&&console.log("changes for group %o: %o",e.link,a[c])}});d=0;$.each(a,function(e,h){function l(){++d;f(m,{notif:n,link:k.link});d==a.length&&(crapi.updateAll({watchlist:c}),p())}var k=b[e],m="modationwatch"+k.link.hashCode(),n={type:"basic",iconUrl:"img/newiconflat128.png",title:g[e].title,message:h.join(", ")};h.length?f(m)?l():chrome.notifications.create(m,
n,function(){l()}):++d})}})})}else console.info("Not logged in, skipping watchlist")})})}function f(a,b){var c=localStorage.notifData;c=c?$.parseJSON(c):{};if("undefined"==typeof a)return c;"undefined"==typeof b&&(b=!1);var e=c[a];""===b?delete c[a]:b&&(c[a]=b);localStorage.notifData=JSON.stringify(c);return e}function B(){var a=f();$.each(a,function(a,b){chrome.notifications.create(a,b.notif,function(){})});a.modation_login||p()}function p(){var a=Object.keys(f()).length;crapi.badge({title:0===a?
"No new notifications :(":a+" new notification"+(1<a?"s":""),color:"red",text:a?String(a):""})}function v(){$.each(cacheKeys,function(a,b){delete localStorage[b]});console.info("Cache cleared")}function C(){crapi.clone({options:global.optionDefaults},function(a){console.log("cache options");localJSON("options",a.options)})}(function(){chrome.runtime.onInstalled.addListener(function(a){v();b(a)});chrome.runtime.onStartup.addListener(function(){v();C();p()});chrome.runtime.onMessage.addListener(function(a,
b,c){if(msgFunctions[a.action])msgFunctions[a.action](a,b,c)});msgFunctions.confirm=function(a,b,c){c(confirm(a.msg))};msgFunctions.rememberMe=function(){chrome.cookies&&chrome.cookies.onChanged.addListener(function(a){"explicit"!=a.cause&&g()})}()})();(function(){chrome.alarms.create("feed",{delayInMinutes:modapi.manifest.debug?0:1,periodInMinutes:1});chrome.alarms.create("watchlist",{delayInMinutes:modapi.manifest.debug?0:1,periodInMinutes:10});chrome.alarms.onAlarm.addListener(d);handle($("body"),
"alarm.initAlarms",function(){d({name:"feed"});d({name:"watchlist"})})})();(function(){function a(a,e,d){"undefined"!=typeof d&&(d=f(e).actions[d],d.data.method?$.post(d.link,{_method:d.data.method,authenticity_token:modapi.token()}):a=d.link);chrome.windows.getCurrent(function(b){chrome.tabs.create({windowId:b.id,url:a});chrome.windows.update(b.id,{focused:!0})});b(e)}function b(a){chrome.notifications.clear(a);f(a).clear&&$.post(f(a).clear,{_method:"delete",authenticity_token:modapi.token()});f(a,
"");p()}chrome.notifications.onClicked.addListener(function(b){var c=f(b);c&&a(c.link,b)});chrome.notifications.onButtonClicked.addListener(function(b,d){var c=f(b);if(c){var e=c.actions[d];e.data.confirm?confirm(e.data.confirm)&&a(c.link,b,d):a(c.link,b,d)}});chrome.notifications.onClosed.addListener(function(a,d){d&&b(a)});msgFunctions.showAllNotifications=function(){B()}})();(function(){msgFunctions.watchlistItemType=function(a,b,c){c(h(a.link))};msgFunctions.parseWatchlistItem=function(a,b,c){c(k(a.link,
a.html,a.type))}})()});
