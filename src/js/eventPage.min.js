var alarmRunning=false;var notifData={};$(function(){initInstall();initAlarms();initNotifs()});
function initInstall(){if(localStorage.version==modapi.manifest.version)return;var now=moment().format();localStorage.installed=now;localStorage.version=modapi.manifest.version;var notif={type:"basic",iconUrl:"img/newiconflat128.png",title:"Modation has updated!",message:"Click here to see what's new."};var id="modation_update";chrome.notifications.update(id,notif,function(updated){if(!updated)chrome.notifications.create(id,notif);notifData[id]={notif:notif,link:"http://cyberbit.github.io/modation/",
actions:[]}})}function initAlarms(){chrome.alarms.create("feed",{delayInMinutes:modapi.manifest.debug?0:1,periodInMinutes:1});chrome.alarms.onAlarm.addListener(alarmHandler)}
function initNotifs(){chrome.notifications.onClicked.addListener(function(notifId){var data=notifData[notifId];if(data)_follow(data.link,notifId)});chrome.notifications.onButtonClicked.addListener(function(notifId,i){var data=notifData[notifId];if(data){var btn=data.actions[i];if(btn.data.confirm){if(confirm(btn.data.confirm))_follow(data.link,notifId,i)}else _follow(data.link,notifId,i)}});chrome.notifications.onClosed.addListener(function(notifId,user){if(user)_clear(notifId)});function _follow(link,
id,i){if(typeof i!="undefined"){var btn=notifData[id].actions[i];if(!btn.data.method)link=btn.link;else $.post(btn.link,{_method:btn.data.method,authenticity_token:modapi.token()})}chrome.windows.getCurrent(function(window){chrome.tabs.create({windowId:window.id,url:link});chrome.windows.update(window.id,{focused:true})});_clear(id)}function _clear(id){chrome.notifications.clear(id);if(notifData[id].clear)$.post(notifData[id].clear,{_method:"delete",authenticity_token:modapi.token()})}}
function alarmHandler(alarm){var views=chrome.extension.getViews({type:"popup"});crapi.clone(function(d){modapi.login(function(me){if(alarm.name=="feed")try{if(!me.success){console.warn("Could not login to Soundation");var actions=[{title:"Login with Facebook",link:global.path.home+"/users/auth/facebook",data:{}},{title:"Login with Google",link:global.path.home+"/users/auth/google_oauth2",data:{}}];var notif={type:"basic",iconUrl:"img/newiconflat128.png",title:"Login to Soundation",message:"Click here to login, or use one of the buttons below.",
buttons:actions.map(function(v){return{title:v.title}})};var id="modation_login";chrome.notifications.update(id,notif,function(updated){if(!updated)chrome.notifications.create(id,notif);notifData[id]={notif:notif,link:global.path.login,actions:actions}});alarmRunning=false}else if(alarmRunning)console.info("Alarm running, notification handler cancelled");else if(views.length)console.info("Popup open, notification handler cancelled");else{alarmRunning=true;console.log("Modation :: Check notifications");
$.get(global.path.feed,function(html){var $html=$(html.deres());var $aside=$html.find("aside");var $notifications=$aside.find(".notifications .notification");$notifications.find("a").each(function(i,e){var $link=$(e);var href=$link.attr("href");$link.attr("href",global.path.home+href)});$notifications.each(function(i,e){var $notif=$(e);var $actions=$notif.find(".actions").children();var $msg=$notif.clone();$msg.find("time, .clear, .actions").remove();var $links=$msg.find("a");$msg.find(".author").remove();
var id="modation"+$notif.find(".clear").attr("href").match(/(?:\/)(\d+)/)[0];var time=$notif.find("time").text();var from=$notif.find(".author").text();var msg=$msg.text().trim();var link=$links.last().attr("href");var clear=$notif.find(".clear").attr("href");var actions=[];$actions.each(function(i,e){actions.push({title:$(this).text(),link:$(this).attr("href"),data:$(this).data()})});var notif={type:"basic",iconUrl:"img/newiconflat128.png",title:from,message:msg,contextMessage:time,buttons:actions.map(function(v){return{title:v.title}})};
chrome.notifications.update(id,notif,function(updated){if(!updated)chrome.notifications.create(id,notif);notifData[id]={notif:notif,link:link,clear:clear,actions:actions}})});alarmRunning=false})}}catch(e){console.error("Unknown error occurred: %o",e);alarmRunning=false}})})};
