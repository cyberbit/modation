/*
 under GNU license
 @author Bevis Zhao (i@bevis.me, http://bevis.me)
*/
$(function(){$.browser={};$.browser.msie=!1;$.browser.mozilla=!1;var g={primaryStyles:"fontFamily fontSize fontWeight fontVariant fontStyle paddingLeft paddingTop paddingBottom paddingRight marginLeft marginTop marginBottom marginRight borderLeftColor borderTopColor borderBottomColor borderRightColor borderLeftStyle borderTopStyle borderBottomStyle borderRightStyle borderLeftWidth borderTopWidth borderBottomWidth borderRightWidth line-height outline text-align".split(" "),specificStyle:{"word-wrap":"break-word",
"overflow-x":"hidden","overflow-y":"auto"},simulator:$('<div id="textarea_simulator"/>').css({position:"absolute",top:0,left:0,visibility:"hidden"}).appendTo(document.body),toHtml:function(b){return b.replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\n/g,"<br>").split(" ").join('<span style="white-space:prev-wrap">&nbsp;</span>')},getCaretPosition:function(){var b=g,c=this,a=c[0],d=c.offset();if($.browser.msie&&9>=$.browser.version){a.focus();var e=document.selection.createRange();$("#hskeywords").val(a.scrollTop);
return{left:e.boundingLeft-d.left,top:parseInt(e.boundingTop)-d.top+a.scrollTop+document.documentElement.scrollTop+parseInt(c.getComputedStyle("fontSize"))}}b.simulator.empty();$.each(b.primaryStyles,function(a,d){c.cloneStyle(b.simulator,d)});b.simulator.css($.extend({width:c.width(),height:c.height()},b.specificStyle));var e=c.val()||c.text(),f=c.getCursorPosition(),d=e.substring(0,f),e=e.substring(f),f=$('<span class="before"/>').html(b.toHtml(d)),d=$('<span class="focus"/>'),e=$('<span class="after"/>').html(b.toHtml(e));
b.simulator.append(f).append(d).append(e);e=d.offset();f=b.simulator.offset();return{top:e.top-f.top-a.scrollTop+($.browser.mozilla?0:parseInt(c.getComputedStyle("fontSize"))),left:d[0].offsetLeft-b.simulator[0].offsetLeft-a.scrollLeft}}};$.fn.extend({setCursorPosition:function(b){return 0==this.length?this:$(this).setSelection(b,b)},setSelection:function(b,c){if(0==this.length)return this;input=this[0];if(input.createTextRange){var a=input.createTextRange();a.collapse(!0);a.moveEnd("character",c);
a.moveStart("character",b);a.select()}else if(input.setSelectionRange)input.focus(),input.setSelectionRange(b,c);else{var d=this.get(0),a=document.createRange();a.collapse(!0);a.setStart(d.childNodes[0],b);a.setEnd(d.childNodes[0],c);d=window.getSelection();d.removeAllRanges();d.addRange(a)}return this},getComputedStyle:function(b){if(0!=this.length){var c=this[0],a=this.css(b);return a=a||($.browser.msie?c.currentStyle[b]:document.defaultView.getComputedStyle(c,null)[b])}},cloneStyle:function(b,
c){var a=this.getComputedStyle(c);a&&$(b).css(c,a)},cloneAllStyle:function(b,c){var a=this[0],d;for(d in a.style){var e=a.style[d];"string"==typeof e||"number"==typeof e?this.cloneStyle(b,d):NaN}},getCursorPosition:function(){var b=input=this[0],c=input.value||input.innerText;this.data("lastCursorPosition")||this.data("lastCursorPosition",0);var a=this.data("lastCursorPosition");if(document.selection)input.focus(),b=document.selection.createRange(),a=document.selection.createRange().text.length,b.moveStart("character",
-c.length),a=b.text.length-a;else{if(input.selectionStart||"0"==input.selectionStart)return input.selectionStart;if("undefined"!=typeof window.getSelection&&0<window.getSelection().rangeCount)try{var d=window.getSelection().getRangeAt(0),e=d.cloneRange();e.selectNodeContents(b);e.setEnd(d.endContainer,d.endOffset);a=e.toString().length}catch(f){a=this.data("lastCursorPosition")}else"undefined"!=typeof document.selection&&"Control"!=document.selection.type&&(c=document.selection.createRange(),a=document.body.createTextRange(),
a.moveToElementText(b),a.setEndPoint("EndToEnd",c),a=a.text.length)}this.data("lastCursorPosition",a);return a},getCaretPosition:g.getCaretPosition})});
