var storage={},me={},msgFunctions={};function preinit(){msgFunctions.onHistoryStateUpdated=function(t){var e=t.meta;console.log("Location changed to %o",e.url);var o=e.url.matchAny({message:global.regex.messageLink,group:global.regex.groupLink,track:global.regex.trackLink,profile:global.regex.profileLink,general:global.regex.generalLink},!0);console.log("Triggered %o scripts",o)},msgFunctions.onHistoryStateUpdated({meta:{url:location.href}}),chrome.runtime.onMessage.addListener(function(t,e,o){msgFunctions[t.action]&&msgFunctions[t.action](t,e,o)}),$.get(chrome.extension.getURL("content.html"),function(t){$("body").append(t),crapi.clone(function(t){var o,e,n,i,a,r,u;(storage=t).options.userTags&&function(){var o=storage.options.userTagLinks,t=$(".new_comment #comment_content");if(t.length){var e=$(".main div.comments"),n=e.find(".comment .content > h4").map(function(){return o?$(this).html():$(this).text()}).get().unique(),i=[];$.each(n,function(t,e){i.push({val:e})}),t.sew({values:i,elementFactory:function(t,e){t.html(o?$(e.val).text():e.val)}})}}(),storage.options.moveCommentBox&&function(){var t=$(".write-comment");if(t.length){var e=t.prevAll("h3").first(),o=t.siblings("div.comments");t.addClass("mod-write-comment"),o.addClass("mod-comments"),e.after(t)}}(),storage.options.groupFilters&&(o=$(".main .group-list"),e=_factory(".modation-factory",".modation-group-filter"),n=e.find(".filter"),o.addClass("mod-group-list"),o.before(e),o.isotope({itemSelector:".group",layoutMode:"vertical",transitionDuration:".3s"}),o.imagesLoaded().progress(function(){o.isotope("layout")}),handle(n,"input.initGroups",function(){var t=$(this),e=t.val(),n=e.toLowerCase();o.isotope({filter:function(){var t=$(this),e=t.find(".name"),o=e.text().toLowerCase();return-1!=o.indexOf(n)}})})),storage.options.moveGroupInvites&&(i=$(".main .group-list"),a=$(".main .invitations"),r=a.prev("h3"),a.addClass("mod-group-invites"),i.before(a),a.before(r)),storage.options.showAlertsOnTop&&$(".alert").addClass("mod-alert"),storage.options.watchlist&&(u=global.path.home+location.pathname,chrome.runtime.sendMessage({action:"watchlistItemType",link:u},function(t){var i=t;if(i){var a,r,s={watchlist:storage.watchlist},e=s.watchlist,l=e.findIndex(function(t){return t.link==u}),o=$("aside > section").first(),n=_factory(".modation-factory",".modation-watchlist-actions"),c=n.children(".add"),m=n.children(".remove");o.before(n),function o(){var t=~l;if(t){r=c;var e=(a=m).find(".unwatch");handle(e,"click.initWatchlist",function(t){t.preventDefault();var e=s.watchlist.splice(l,1);crapi.updateAll(s,function(t){t?(global.debug&&console.log("item unwatched! %o",e),l=-1,o()):console.error("Item not unwatched due to storage lock! Please try again in a few seconds.")})})}else{r=m;var n=(a=c).find(".watch");handle(n,"click.initWatchlist",function(t){t.preventDefault(),chrome.runtime.sendMessage({action:"parseWatchlistItem",link:u,html:document.documentElement.innerHTML,type:i},function(t){var e=s.watchlist.push(t.updates)-1;crapi.updateAll(s,function(t){t?(global.debug&&console.log("item watched! %o",s),l=e,o()):console.error("Item not watched due to storage lock! Please try again in a few seconds.")})})})}showView(r,a,0)}()}})),modapi.login(function(t){me=t})})})}preinit();