var alarmRunning=!1,msgFunctions={};
$(function(){function l(b){crapi.clone($.extend(!0,{},global.storageModel,{options:global.optionDefaults}),function(c){function a(){var a=moment().format();localStorage.installed=a;localStorage.version=f;var c={type:"basic",iconUrl:"img/newiconflat128.png",title:"Modation has updated!",message:"Click here to see what's new.",contextMessage:("update"==b.reason?"v"+b.previousVersion+" => ":"")+"v"+f};chrome.notifications.create("modation_update",c,function(a){e("modation_update",{notif:c,link:"http://djmarcolesco.me/modation/",
actions:[]})})}var f=crapi.manifest().version;c.version||(crapi.storage("local").clear(),crapi.storage("sync").clear(),console.info("No storage version, clearing storage"));c.version!==f?crapi.updateAll($.extend(!0,{},global.storageModel,c,{version:f}),function(){console.info("Updated storage model");a()}):a()})}function e(b,c){var a=localStorage.notifData,a=a?$.parseJSON(a):{};if("undefined"==typeof b)return a;"undefined"==typeof c&&(c=!1);var f=a[b];""===c?delete a[b]:c&&(a[b]=c);localStorage.notifData=
JSON.stringify(a);return f}function q(){var b=e();$.each(b,function(b,a){chrome.notifications.create(b,a.notif,function(){})});b.modation_login||m()}function m(){var b=Object.keys(e()).length;crapi.badge({title:0==b?"No new notifications :(":b+" new notification"+(1<b?"s":""),color:"red",text:b?String(b):""})}(function(){chrome.runtime.onInstalled.addListener(function(b){l(b)});chrome.runtime.onStartup.addListener(function(){delete localStorage.notifData;m()});chrome.runtime.onMessage.addListener(function(b,
c,a){if(msgFunctions[b.action])msgFunctions[b.action](b,c,a)});msgFunctions.confirm=function(b,c,a){a(confirm(b.msg))}})();chrome.alarms.create("feed",{delayInMinutes:modapi.manifest.debug?0:1,periodInMinutes:1});chrome.alarms.onAlarm.addListener(function(b){var c=chrome.extension.getViews({type:"popup"});crapi.clone(function(a){modapi.login(function(a){if("feed"==b.name)try{if(a.success)alarmRunning?console.info("Alarm running, notification handler cancelled"):c.length?console.info("Popup open, notification handler cancelled"):
(e("modation_login",""),alarmRunning=!0,console.log("Modation :: Check notifications"),$.get(global.path.feed,function(a){a=$(a.deres()).find("aside").find(".notifications .notification");var b=[],c=[];a.find("a").each(function(a,b){var c=$(b),f=c.attr("href");c.attr("href",global.path.home+f)});var f=0;a.each(function(a,d){function g(){e(n,{notif:s,link:p,clear:u,actions:r});++f;f==Object.keys(e()).length&&m()}var h=$(d),l=h.find(".actions").children(),k=h.clone();k.find("time, .clear, .actions").remove();
var t=k.find("a");k.find(".author").remove();var n="modation"+h.find(".clear").attr("href").match(/(?:\/)(\d+)/)[1],q=h.find("time").text(),v=h.find(".author").text(),k=k.text().trim(),p=t.last().attr("href"),u=h.find(".clear").attr("href"),r=[];l.each(function(a,b){r.push({title:$(this).text(),link:$(this).attr("href"),data:$(this).data()})});if(p.match(/\/account\/messages\/\d+$/)){if(-1!=$.inArray(p,b))return;b.push(p)}c.push(n);var s={type:"basic",iconUrl:"img/newiconflat128.png",title:v,message:k,
contextMessage:q,buttons:r.map(function(a){return{title:a.title}})};e(n)?g():chrome.notifications.create(n,s,function(a){g()})});a=Object.keys(e());$.each(a.diff(c),function(a,b){chrome.notifications.clear(b);e(b,"")});0===f&&m();alarmRunning=!1}));else{console.warn("Could not login to Soundation");crapi.badge({title:"Please login to view notifications",color:"gray",text:"?"});var d=[{title:"Login with Facebook",link:global.path.home+"/users/auth/facebook",data:{}},{title:"Login with Google",link:global.path.home+
"/users/auth/google_oauth2",data:{}}],g={type:"basic",iconUrl:"img/newiconflat128.png",title:"Login to Soundation",message:"Click here to login, or use one of the buttons below.",buttons:d.map(function(a){return{title:a.title}})};e("modation_login")||chrome.notifications.create("modation_login",g,function(a){e("modation_login",{notif:g,link:global.path.login,actions:d})});alarmRunning=!1}}catch(l){console.error("Unknown error occurred: %o",l),alarmRunning=!1}})})});(function(){function b(a,b,d){"undefined"!=
typeof d&&(d=e(b).actions[d],d.data.method?$.post(d.link,{_method:d.data.method,authenticity_token:modapi.token()}):a=d.link);chrome.windows.getCurrent(function(b){chrome.tabs.create({windowId:b.id,url:a});chrome.windows.update(b.id,{focused:!0})});c(b)}function c(a){chrome.notifications.clear(a);e(a).clear&&$.post(e(a).clear,{_method:"delete",authenticity_token:modapi.token()});e(a,"");m()}chrome.notifications.onClicked.addListener(function(a){var c=e(a);c&&b(c.link,a)});chrome.notifications.onButtonClicked.addListener(function(a,
c){var d=e(a);if(d){var g=d.actions[c];g.data.confirm?confirm(g.data.confirm)&&b(d.link,a,c):b(d.link,a,c)}});chrome.notifications.onClosed.addListener(function(a,b){b&&c(a)});msgFunctions.showAllNotifications=function(a){q()}})()});
