var alarmRunning=!1,msgFunctions={},cacheKeys=["notifData","blobs","options"];
$(function(){function y(a){crapi.clone($.extend(!0,{},global.storageModel,{options:global.optionDefaults}),function(d){function c(){var c=moment().format();localStorage.installed=c;localStorage.version=b;localJSON("options",d.options);var e={type:"basic",iconUrl:"img/newiconflat128.png",title:"Modation has updated!",message:"Click here to see what's new.",contextMessage:("update"==a.reason?"v"+a.previousVersion+" => ":"")+"v"+b};chrome.notifications.create("modation_update",e,function(){f("modation_update",
{notif:e,link:"http://djmarcolesco.me/modation/",actions:[]})})}var b=crapi.manifest().version;d.version||(crapi.storage("local").clear(),crapi.storage("sync").clear(),console.info("No storage version, clearing storage"));d.version!==b||"update"==a.reason?crapi.updateAll($.extend(!0,{},global.storageModel,d,{version:b}),function(){console.info("Updated storage model");c()}):c()})}function z(){(function(a){a.rememberMe&&chrome.cookies.get({url:global.path.cookie,name:global.cookie},function(a){a=a||
{};a.session&&chrome.cookies.set({url:global.path.cookie,name:global.cookie,value:a.value,domain:a.domain,path:a.path,secure:a.secure,httpOnly:a.httpOnly,expirationDate:moment().add(1,"w").unix()},function(){})})})(localJSON("options"))}function q(a){return a.matchAny({group:global.regex.groupLink,track:global.regex.trackLink})}function w(a,d,c){c=c||q(a);var b=global.watchlistModel[c];b.link=a;a=$(d);if("track"==c){d=parseInt(a.find(".stats .likes").text());var g=parseInt(a.find(".stats .downloads").text());
a=parseInt(a.find(".stats .comments").text());$.extend(b,{likes:d,downloads:g,comments:a})}else if("group"==c){d=(a.find(".comments .comment:first .content > p").html()||"").hashCode();var g=parseInt(a.find(".stats a[href*=members] b").text()),f=parseInt(a.find(".stats a[href*=followers] b").text());a=parseInt(a.find(".stats a[href*=tracks] b").text());$.extend(b,{lastComment:d,members:g,followers:f,tracks:a})}return{updates:b,type:c}}function h(a){var d=chrome.extension.getViews({type:"popup"}),
c=localJSON("options")||{};modapi.login(function(b){if("feed"==a.name)try{if(b.success)alarmRunning?console.info("Alarm running, notification handler cancelled"):d.length?console.info("Popup open, notification handler cancelled"):(f("modation_login",""),alarmRunning=!0,console.log("Modation :: Check notifications"),$.get(global.path.feed,function(a){var c=$(a.deres()).find("aside").find(".notifications .notification"),d=[],b=[];c.find("a").attr("href",function(a,c){return global.path.home+c});var g=
0;c.each(function(a,B){function e(a){function d(){f(r,{notif:b,link:m,clear:A,actions:v});++g;g==c.length&&l()}var b={type:"basic",iconUrl:a,title:h,message:q,contextMessage:k,buttons:v.map(function(a){return{title:a.title}})};f(r)?d():chrome.notifications.create(r,b,function(){d()})}var n=$(B),C=n.find(".actions").children(),p=n.clone();p.find("time, .clear, .actions").remove();var D=p.find("a");p.find(".author").remove();var r="modation"+n.find(".clear").attr("href").match(/(?:\/)(\d+)/)[1],k=n.find("time").text(),
s=n.find(".author"),h=s.text(),u=s.attr("href"),q=p.text().trim(),m=D.last().attr("href"),A=n.find(".clear").attr("href"),v=[];C.each(function(){v.push({title:$(this).text(),link:$(this).attr("href"),data:$(this).data()})});if(m.match(global.regex.messageLink)){if(-1!=$.inArray(m,d))return;d.push(m)}b.push(r);var t=m.match(global.regex.groupLink),n=localJSON("blobs")||{};n[t?m:u]?e(n[t?m:u]):$.get(t?m:u,function(a){a=$(a).find((t?".top .inner .container":"aside")+" img").attr("src");getDataUri("img/newiconflat128.png",
a,function(a){var c=localJSON("blobs")||{};c[t?m:u]=a;localJSON("blobs",c);e(a)})})});a=Object.keys(f()).filter(function(a){return a.match(/modation(\d)+/)});$.each(a.diff(b),function(a,c){chrome.notifications.clear(c);f(c,"")});0===g&&l();alarmRunning=!1}));else{console.warn("Could not login to Soundation");crapi.badge({title:"Please login to view notifications",color:"gray",text:"?"});var g=[{title:"Login with Facebook",link:global.path.home+"/users/auth/facebook",data:{}},{title:"Login with Google",
link:global.path.home+"/users/auth/google_oauth2",data:{}}],e={type:"basic",iconUrl:"img/newiconflat128.png",title:"Login to Soundation",message:"Click here to login, or use one of the buttons below.",buttons:g.map(function(a){return{title:a.title}})};f("modation_login")||chrome.notifications.create("modation_login",e,function(){f("modation_login",{notif:e,link:global.path.login,actions:g})});alarmRunning=!1}}catch(h){console.error("Unknown error occurred: %o",h),alarmRunning=!1}else"watchlist"==
a.name&&c.watchlist&&crapi.clone(["watchlist"],function(a){if(b.success){var c="undefined"==typeof testWatchlist?a.watchlist:testWatchlist,d=[],g=[],e=0;$.each(c,function(a,b){d[a]=b;g[a]={};var h=q(b.link);g[a].type=h;$.get(b.link,function(c){c=$(c);var e=w(b.link,c,h).updates;if("track"==h)g[a].title=c.find(".main > h2").text(),global.debug&&console.log("track %o: current %o, new %o",b.link,{likes:b.likes,downloads:b.downloads,comments:b.comments},e);else if("group"==h){var p=c.find(".comments .comment:first"),
f=p.find(".content > h4 a"),p=p.find(".content > p");g[a].title=c.find(".top .inner .container h2").text();g[a].commentBody=p.text();g[a].commentAuthor=f.text();g[a].commentAuthorLink=f.attr("href");global.debug&&console.log("group %o: current %o, new %o",b.link,{lastComment:b.lastComment,members:b.members,followers:b.followers,tracks:b.tracks},e)}d[a]=$.extend({},d[a],e)}).always(function(){++e;if(e==c.length){var a=[];$.each(d,function(b,d){var e=c[b],f=g[b];a[b]=[];if("track"==f.type){var f=d.likes-
e.likes,k=d.downloads-e.downloads,e=d.comments-e.comments;f&&a[b].push(f+" like"+(1==Math.abs(f)?"":"s"));k&&a[b].push(k+" download"+(1==Math.abs(k)?"":"s"));e&&a[b].push(e+" comment"+(1==Math.abs(e)?"":"s"));global.debug&&console.log("changes for track %o: %o",d.link,a[b])}else if("group"==f.type){var k=d.followers-e.followers,h=d.members-e.members,l=d.tracks-e.tracks;d.lastComment!==e.lastComment&&f.commentBody&&a[b].push("New comment from @"+f.commentAuthor);k&&a[b].push(k+" follower"+(1==Math.abs(k)?
"":"s"));h&&a[b].push(h+" member"+(1==Math.abs(h)?"":"s"));l&&a[b].push(l+" track"+(1==Math.abs(l)?"":"s"));global.debug&&console.log("changes for group %o: %o",d.link,a[b])}});e=0;$.each(a,function(b,h){function q(){++e;f(k,{notif:s,link:r.link});e==a.length&&(crapi.updateAll({watchlist:d}),l())}var r=c[b],k="modationwatch"+r.link.hashCode(),s={type:"basic",iconUrl:"img/newiconflat128.png",title:g[b].title,message:h.join(", ")};h.length?f(k)?q():chrome.notifications.create(k,s,function(){q()}):++e})}})})}else console.info("Not logged in, skipping watchlist")})})}
function f(a,d){var c=localStorage.notifData,c=c?$.parseJSON(c):{};if("undefined"==typeof a)return c;"undefined"==typeof d&&(d=!1);var b=c[a];""===d?delete c[a]:d&&(c[a]=d);localStorage.notifData=JSON.stringify(c);return b}function E(){var a=f();$.each(a,function(a,c){chrome.notifications.create(a,c.notif,function(){})});a.modation_login||l()}function l(){var a=Object.keys(f()).length;crapi.badge({title:0===a?"No new notifications :(":a+" new notification"+(1<a?"s":""),color:"red",text:a?String(a):
""})}function x(){$.each(cacheKeys,function(a,d){delete localStorage[d]});console.info("Cache cleared")}function F(){crapi.clone({options:global.optionDefaults},function(a){console.log("cache options");localJSON("options",a.options)})}(function(){chrome.runtime.onInstalled.addListener(function(a){x();y(a)});chrome.runtime.onStartup.addListener(function(){x();F();l()});chrome.runtime.onMessage.addListener(function(a,d,c){if(msgFunctions[a.action])msgFunctions[a.action](a,d,c)});msgFunctions.confirm=
function(a,d,c){c(confirm(a.msg))};msgFunctions.rememberMe=function(){chrome.cookies&&chrome.cookies.onChanged.addListener(function(a){"explicit"!=a.cause&&z()})}()})();(function(){chrome.alarms.create("feed",{delayInMinutes:modapi.manifest.debug?0:1,periodInMinutes:1});chrome.alarms.create("watchlist",{delayInMinutes:modapi.manifest.debug?0:1,periodInMinutes:10});chrome.alarms.onAlarm.addListener(h);handle($("body"),"alarm.initAlarms",function(){h({name:"feed"});h({name:"watchlist"})})})();(function(){function a(a,
b,g){"undefined"!=typeof g&&(g=f(b).actions[g],g.data.method?$.post(g.link,{_method:g.data.method,authenticity_token:modapi.token()}):a=g.link);chrome.windows.getCurrent(function(b){chrome.tabs.create({windowId:b.id,url:a});chrome.windows.update(b.id,{focused:!0})});d(b)}function d(a){chrome.notifications.clear(a);f(a).clear&&$.post(f(a).clear,{_method:"delete",authenticity_token:modapi.token()});f(a,"");l()}chrome.notifications.onClicked.addListener(function(c){var b=f(c);b&&a(b.link,c)});chrome.notifications.onButtonClicked.addListener(function(c,
b){var d=f(c);if(d){var e=d.actions[b];e.data.confirm?confirm(e.data.confirm)&&a(d.link,c,b):a(d.link,c,b)}});chrome.notifications.onClosed.addListener(function(a,b){b&&d(a)});msgFunctions.showAllNotifications=function(){E()}})();(function(){msgFunctions.watchlistItemType=function(a,d,c){c(q(a.link))};msgFunctions.parseWatchlistItem=function(a,d,c){c(w(a.link,a.html,a.type))}})()});
